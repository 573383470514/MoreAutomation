<UserControl x:Class="MoreAutomation.UI.Modules.AccountManagement.AccountListView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:MoreAutomation.UI.Modules.AccountManagement">
    <UserControl.Resources>
        <local:InverseBooleanToVisibilityConverter x:Key="InvBoolToVis" />
    </UserControl.Resources>
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
            <Button Content="刷新" Command="{Binding LoadAccountsCommand}" Width="80"/>
            <Button Content="添加账号" Command="{Binding ToggleAddPanelCommand}" Margin="10,0,0,0" Width="80"/>
            <TextBlock Margin="10,0,5,0" VerticalAlignment="Center" Text="区服号："/>
            <ComboBox Width="80" Margin="0,0,10,0" SelectedValue="{Binding SelectedServerId}" ItemsSource="{Binding ServerIds}">
                <ComboBox.ToolTip>
                    <TextBlock Text="选择要登录的区服号（1~10）"/>
                </ComboBox.ToolTip>
            </ComboBox>
            <TextBox Width="200" Margin="10,0,0,0" Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" Padding="5" Background="#FAFAFA" Foreground="#333">
                <TextBox.ToolTip>
                    <TextBlock Text="搜索账号或备注（支持模糊匹配）"/>
                </TextBox.ToolTip>
            </TextBox>
            <TextBlock Margin="10,0,5,0" VerticalAlignment="Center" Text="筛选组号："/>
            <ComboBox Width="100" Margin="0,0,10,0" SelectedValue="{Binding SelectedGroup}" IsEditable="True">
                <ComboBox.ItemsSource>
                    <Binding Path="Groups"/>
                </ComboBox.ItemsSource>
                <ComboBox.ToolTip>
                    <TextBlock Text="按组号筛选，清空可取消筛选"/>
                </ComboBox.ToolTip>
            </ComboBox>
            <CheckBox Content="隐藏敏感信息" VerticalAlignment="Center" IsChecked="{Binding HideSensitive}">
                <CheckBox.ToolTip>
                    <TextBlock Text="取消显示账号、组号和主控状态"/>
                </CheckBox.ToolTip>
            </CheckBox>
        </StackPanel>

        <!-- Inline add panel -->
        <Border Grid.Row="1" BorderBrush="#EEE" BorderThickness="1" Padding="8" Background="#FFF" Visibility="{Binding ShowAddPanel, Converter={StaticResource InvBoolToVis}, ConverterParameter=''}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="120"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock Text="账号:" VerticalAlignment="Center"/>
                <TextBox Grid.Column="1" Text="{Binding NewAccountNumber}" />
                <TextBlock Grid.Column="0" Grid.Row="1" Text="密码:" VerticalAlignment="Center" Margin="0,8,0,0"/>
                <PasswordBox Grid.Column="1" Grid.Row="1" x:Name="NewPwdBox" PasswordChanged="NewPwdBox_PasswordChanged" Visibility="{Binding ShowNewPassword, Converter={StaticResource InvBoolToVis}}"/>
                <TextBox Grid.Column="1" Grid.Row="1" Text="{Binding NewPassword}" Visibility="{Binding ShowNewPassword, Converter={StaticResource BooleanToVisibilityConverter}}" Margin="0,8,0,0"/>
                <CheckBox Grid.Column="2" Grid.Row="1" Content="显示密码" IsChecked="{Binding ShowNewPassword}" VerticalAlignment="Center" Margin="8,8,0,0"/>
                <TextBlock Grid.Column="0" Grid.Row="2" Text="组号:" VerticalAlignment="Center" Margin="0,8,0,0"/>
                <TextBox Grid.Column="1" Grid.Row="2" Text="{Binding NewGroup}" Margin="0,8,0,0"/>
                <TextBlock Grid.Column="0" Grid.Row="3" Text="备注:" VerticalAlignment="Center" Margin="0,8,0,0"/>
                <TextBox Grid.Column="1" Grid.Row="3" Text="{Binding NewNote}" Margin="0,8,0,0"/>
                <StackPanel Grid.Column="2" Grid.Row="3" Orientation="Horizontal" VerticalAlignment="Bottom" Margin="8,8,0,0">
                    <Button Content="取消" Command="{Binding CancelAddCommand}" Width="70" Margin="0,0,8,0"/>
                    <Button Content="添加" Command="{Binding ConfirmAddCommand}" Width="70"/>
                </StackPanel>
            </Grid>
        </Border>

        <TextBlock Grid.Row="2" Text="💡 双击账号行登录 | 右键选项：设为主控或配置代理 | 使用上移/下移调整序号 | 搜索框支持模糊匹配" Foreground="#666" Margin="0,0,0,6" FontSize="11"/>

        <DataGrid Grid.Row="3" ItemsSource="{Binding AccountsView}" AutoGenerateColumns="False" CanUserAddRows="False" GridLinesVisibility="Horizontal" BorderBrush="#DDD" RowHeaderWidth="0">
            <DataGrid.Columns>
                <DataGridTextColumn Header="序号" Binding="{Binding SortIndex}" Width="50"/>
                <DataGridTemplateColumn Header="账号" Width="120">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding AccountNumber}" Visibility="{Binding DataContext.HideSensitive, RelativeSource={RelativeSource AncestorType=DataGrid}, Converter={StaticResource InvBoolToVis}}" />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
                <DataGridTemplateColumn Header="组号" Width="80">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding GroupId}" Visibility="{Binding DataContext.HideSensitive, RelativeSource={RelativeSource AncestorType=DataGrid}, Converter={StaticResource InvBoolToVis}}" />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
                <DataGridTemplateColumn Header="主控" Width="50">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <CheckBox IsChecked="{Binding IsMaster}" IsEnabled="False" Visibility="{Binding DataContext.HideSensitive, RelativeSource={RelativeSource AncestorType=DataGrid}, Converter={StaticResource InvBoolToVis}}" />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
                <DataGridTextColumn Header="备注" Binding="{Binding Note}" Width="*"/>
                <DataGridTemplateColumn Header="操作" Width="160">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal">
                                <Button Content="上移" Command="{Binding DataContext.MoveUpCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}" CommandParameter="{Binding}" Width="50" Margin="0,0,4,0"/>
                                <Button Content="下移" Command="{Binding DataContext.MoveDownCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}" CommandParameter="{Binding}" Width="50" Margin="0,0,4,0"/>
                                <Button Content="删除" Command="{Binding DataContext.DeleteAccountCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}" 
                                        CommandParameter="{Binding}" Background="Transparent" Foreground="Red" BorderThickness="0" Width="40"/>
                            </StackPanel>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
            </DataGrid.Columns>
            <DataGrid.RowStyle>
                <Style TargetType="DataGridRow">
                    <EventSetter Event="PreviewMouseRightButtonDown" Handler="DataGridRow_PreviewMouseRightButtonDown"/>
                    <EventSetter Event="MouseDoubleClick" Handler="DataGridRow_MouseDoubleClick"/>
                    <Setter Property="ContextMenu">
                        <Setter.Value>
                            <ContextMenu>
                                <MenuItem Header="登录" Command="{Binding DataContext.LoginAccountCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}" CommandParameter="{Binding}"/>
                                <Separator/>
                                <MenuItem Header="设为主控" Command="{Binding DataContext.SetMasterCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}" CommandParameter="{Binding}"/>
                                <MenuItem Header="配置代理..." Click="ConfigureProxy_Click"/>
                            </ContextMenu>
                        </Setter.Value>
                    </Setter>
                </Style>
            </DataGrid.RowStyle>
        </DataGrid>
    </Grid>
</UserControl>